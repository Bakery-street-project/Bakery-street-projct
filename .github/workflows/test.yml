name: Bakery Street Project - Organization Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov coverage
        
    - name: Run organization tests with coverage
      run: |
        coverage run --source=. tests/test_organization.py
        
    - name: Run negative test cases with coverage
      env:
        COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
      run: |
        # Run negative test cases for Lambda handlers
        coverage run --append --source=. tests/test_lambda_woofy_handler_negative.py
        
    - name: Generate coverage report
      run: |
        coverage report --show-missing
        coverage xml
        echo "üìä Coverage report generated"
        
    - name: Coverage summary
      run: |
        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
        
    - name: Copilot automation tasks
      if: env.COPILOT_TOKEN != ''
      env:
        COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
      run: |
        echo "ü§ñ Running Copilot automation tasks..."
        # This section can be expanded for Copilot-specific automation
        echo "‚úÖ Copilot token is available for automation"
        
        # Validate security configurations
        echo "üîí Validating security configurations..."
        
        # Check for ADR compliance
        echo "üìã Checking ADR compliance..."
        if [[ -f "architecture/adr/README.md" ]] && [[ -f "architecture/adr/ADR-0001-serverless-baseline-architecture.md" ]]; then
          echo "‚úÖ ADR documentation is complete"
        else
          echo "‚ùå ADR documentation is missing"
          exit 1
        fi
        
    - name: Validate README structure
      run: |
        # Check README exists and has content
        if [[ ! -f "README.md" ]]; then
          echo "Error: README.md not found"
          exit 1
        fi
        
        # Check README size (should be substantial)
        if [[ $(wc -c < README.md) -lt 5000 ]]; then
          echo "Warning: README.md is quite short"
        fi
        
        # Check for essential sections
        for section in "Mission" "Vision" "Featured Projects" "Technology Stack"; do
          if ! grep -q "$section" README.md; then
            echo "Error: Missing '$section' section in README"
            exit 1
          fi
        done
        
        echo "‚úÖ README structure validation passed"
        
    - name: Validate organization logo
      run: |
        if [[ ! -f "image.jpg" ]]; then
          echo "Error: Organization logo (image.jpg) not found"
          exit 1
        fi
        
        # Check logo file size (should be reasonable)
        logo_size=$(wc -c < image.jpg)
        if [[ $logo_size -lt 1000 ]]; then
          echo "Warning: Organization logo seems very small"
        fi
        
        echo "‚úÖ Organization logo validation passed"
        
    - name: Check project structure
      run: |
        # Check for essential files
        for file in "README.md" "requirements.txt" "image.jpg"; do
          if [[ ! -f "$file" ]]; then
            echo "Error: Missing essential file: $file"
            exit 1
          fi
        done
        
        # Check for test directory
        if [[ ! -d "tests" ]]; then
          echo "Error: Tests directory not found"
          exit 1
        fi
        
        echo "‚úÖ Project structure validation passed"
        
    - name: Validate requirements.txt
      run: |
        if [[ -f "requirements.txt" ]]; then
          # Check for common AI/ML packages
          if ! grep -q "tensorflow\|pytorch\|scikit-learn" requirements.txt; then
            echo "Warning: No major AI/ML frameworks found in requirements.txt"
          fi
          
          # Check for web development packages
          if ! grep -q "fastapi\|flask\|django" requirements.txt; then
            echo "Warning: No web frameworks found in requirements.txt"
          fi
          
          echo "‚úÖ Requirements.txt validation passed"
        fi
        
    - name: Check git repository
      run: |
        # Verify this is a git repository
        if [[ ! -d ".git" ]]; then
          echo "Error: Not a git repository"
          exit 1
        fi
        
        # Check for remote origin
        if ! git remote get-url origin >/dev/null 2>&1; then
          echo "Warning: No remote origin configured"
        fi
        
        echo "‚úÖ Git repository validation passed"
        
    - name: Generate test report
      if: always()
      run: |
        echo "üìä Test Summary for Bakery Street Project"
        echo "=========================================="
        echo "Python Version: ${{ matrix.python-version }}"
        echo "Repository: $(git remote get-url origin 2>/dev/null || echo 'No remote')"
        echo "Last Commit: $(git log -1 --format='%h %s' 2>/dev/null || echo 'No commits')"
        echo "Files: $(find . -type f | wc -l)"
        echo "Size: $(du -sh . | cut -f1)"
